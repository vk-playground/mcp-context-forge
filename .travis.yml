# ===============================================================
# Travis CI â€“ twoâ€‘stage build for the mcpgateway project
# ===============================================================
#
# Updated 2025â€‘06â€‘21
#   â€¢ Moves to **Ubuntu 24.04 LTS (Noble Numbat)** build image
#   â€¢ Uses the distroâ€‘default **Python 3.12** (no external PPAs)
#   â€¢ Installs only python3â€‘venv & python3â€‘dev from the main repo
#   â€¢ Keeps the existing twoâ€‘stage workflow (buildâ€‘test â†’ docker)
#
# Stage â¶  buildâ€‘test :
#   â€¢ Creates Python venv       â†’ ~/.venv/mcpgateway
#   â€¢ Runs `make venv install`  (deps + project)
#   â€¢ Executes lint / unitâ€‘test targets
#
# Stage â·  docker :
#   â€¢ Uses the same repo checkout (depthâ€‘1 clone)
#   â€¢ Builds Containerfile â†’ mcpgateway/mcpgateway:latest
#   â€¢ Starts the container and makes a quick health curl
#
# Requirements
#   â€¢ Works on Travis "noble" image (Ubuntu 24.04; system Python 3.12)
#   â€¢ Docker daemon available via services: docker
# ===============================================================

dist: noble            # Ubuntu 24.04 â€“ upâ€‘toâ€‘date packages
language: generic      # using the image's default Python 3.12
services:
  - docker             # enable Docker Engine inside job

git:
  depth: 1             # shallow clone of current branch only

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ensure venv & build headers are available for system Python 3.12
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
addons:
  apt:
    update: true
    packages:
      - python3-venv   # venv module for virtual environments
      - python3-dev    # C headers for compiling wheels

# Display Python version & prep environment
before_install:
  - echo "ğŸ”§ Python version -> $(python3 --version)"  # should be 3.12.x
  - make venv install install-dev                    # installs deps
  - source ~/.venv/mcpgateway/bin/activate

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Job matrix (two explicit stages)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  include:
    # -----------------------------------------------------------
    # â¶  Lint / Tests
    # -----------------------------------------------------------
    - stage: "build-test"
      name: "Lint + unit tests + package (Python 3.12)"
      script:
        - make dist   # builds the package

    # -----------------------------------------------------------
    # â·  Docker build + smoke test
    # -----------------------------------------------------------
    - stage: "docker"
      name: "Build & run Docker image"
      script: |
        set -e
        echo "ğŸ—ï¸  Building containerâ€¦"
        docker build -f Containerfile -t mcpgateway/mcpgateway:latest .

        echo "ğŸš€  Launching containerâ€¦"
        docker run -d --name mcpgateway -p 4444:4444 \
                   -e HOST=0.0.0.0 mcpgateway/mcpgateway:latest

        echo "â³  Waiting for startupâ€¦"
        sleep 10

        echo "ğŸ”  Hitting health endpointâ€¦"
        curl -fsSL http://localhost:4444/health || {
          echo "âŒ Health check failed"; docker logs mcpgateway; exit 1;
        }

        echo "âœ… Container is healthy!"
