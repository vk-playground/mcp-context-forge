# ===============================================================
# Travis CI â€“ two-stage build for the mcpgateway project
# ===============================================================
#
# Stage â¶  build-test :
#   â€¢ Creates a Python venv       â†’ ~/.venv/mcpgateway
#   â€¢ Runs `make venv install`    (== installs deps + project)
#   â€¢ Executes your lint / unit-test targets
#
# Stage â·  docker :
#   â€¢ Uses the same repo checkout (depth-1 clone)
#   â€¢ Builds Containerfile â†’ mcpgateway/mcpgateway:latest
#   â€¢ Starts the container and makes a quick health curl
#
# Requirements
#   â€¢ Works on Travis "jammy" image (Ubuntu 22.04; Python 3.10)
#   â€¢ Docker daemon available via  services: docker
# ===============================================================

dist: jammy                # Ubuntu 22.04 â€“ up-to-date packages
language: generic          # we'll manage Python ourselves
services:
  - docker                 # enable Docker Engine inside job

git:
  depth: 1                 # shallow clone of current branch only

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Global helpers â€“ available to *every* job
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
before_install:
  - echo "ğŸ”§ Python version -> $(python3 --version)"
  - make venv install install-dev       # make target that installs deps
  - source ~/.venv/mcpgateway/bin/activate

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Job matrix (two explicit stages)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  include:
    # -----------------------------------------------------------
    # â¶  Lint / Tests
    # -----------------------------------------------------------
    - stage: "build-test"
      name:  "Lint + unit tests + package"
      script:
        - make dist    # builds the package

    # -----------------------------------------------------------
    # â·  Docker build + smoke test
    # -----------------------------------------------------------
    - stage: "docker"
      name:  "Build & run Docker image"
      script: |
        set -e
        echo "ğŸ—ï¸  Building containerâ€¦"
        docker build -f Containerfile \
                     -t mcpgateway/mcpgateway:latest .

        echo "ğŸš€  Launching containerâ€¦"
        docker run -d --name mcpgateway -p 4444:4444 \
                   mcpgateway/mcpgateway:latest

        echo "â³  Waiting for startupâ€¦"
        sleep 10

        echo "ğŸ”  Hitting health endpointâ€¦"
        curl -fsSL http://localhost:4444/health || {
          echo "âŒ Health check failed"; docker logs mcpgateway; exit 1;
        }

        echo "âœ… Container is healthy!"
