# ===============================================================
# ðŸ” Dependency-Review Workflow â€“ Vulnerabilities â¬§ Licenses
# ===============================================================
#
# This workflow:
#   â€¢ Diffs any dependency changes introduced by pushes or PRs to `main`
#   â€¢ **Fails** when a change introduces either of the following:
#       â†³ A vulnerability of severity â‰¥ MODERATE
#       â†³ A dependency under a "strong-copyleft" license incompatible
#         with this projectâ€™s Apache-2.0 license (see deny-list below)
#   â€¢ Uploads a SARIF report to "Security â†’ Dependency review"
#   â€¢ Adds (or overwrites) a comment on the PR **only on failure**
#
# References
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#   â€¢ Marketplace:  https://github.com/marketplace/actions/dependency-review
#   â€¢ Source code:  https://github.com/github/dependency-review-action  (MIT)
#
# NOTE â–¸ The action is designed for PR events, but it can also run on
#        push & schedule if you supply explicit `base-ref` / `head-ref`
#        (see bottom of `with:` block).
# ===============================================================

name: Dependency Review

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  # Weekly safety-net run â€” useful for catching newly-disclosed CVEs
  # or upstream license changes even when no PR is open.
  schedule:
    - cron: '31 12 * * 6'   # Saturday @ 12:31 UTC

# -----------------------------------------------------------------
# Minimal permissions â€“ principle of least privilege
# -----------------------------------------------------------------
permissions:
  contents:        read          # for actions/checkout
  security-events: write         # upload SARIF results
  pull-requests:   write         # post / overwrite PR comment

jobs:
  dependency-review:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------------------------------------
    # 0ï¸âƒ£  Check out the repository
    # -----------------------------------------------------------
    - name: â¬‡ï¸  Checkout code
      uses: actions/checkout@v4

    # -----------------------------------------------------------
    # 1ï¸âƒ£  Dependency & License gate
    # -----------------------------------------------------------
    - name: ðŸ”  Dependency Review
      id: dep-scan
      uses: actions/dependency-review-action@v4
      with:
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€ Vulnerability policy â”€â”€â”€â”€â”€â”€â”€â”€â”€
        fail-on-severity: moderate      # MODERATE, HIGH, CRITICAL â‡’ âŒ
        vulnerability-check: true       # (default)

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€ License policy â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Hard-deny strong- or service-copyleft licenses that would
        # "infect" an Apache-2.0 project.  (LGPL/MPL/EPL are *not*
        # listed â€” theyâ€™re weak/file-level copyleft.  Add them here
        # if your org chooses to forbid them outright.)
        deny-licenses: >
          GPL-1.0, GPL-2.0, GPL-3.0,
          AGPL-3.0,
          SSPL-1.0,
          RPL-1.5,
          OSL-3.0,
          CPAL-1.0,
          CeCILL-C,
          LicenseRef-clearlydefined-OTHER
        license-check: true             # (default)

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€ UX tweaks â”€â”€â”€â”€â”€â”€â”€â”€â”€
        warn-only: false                # actually fail the workflow
        comment-summary-in-pr: on-failure

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€ Refs for non-PR events â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # These are ignored on pull_request events but allow the
        # scheduled run to compare HEAD against `main`.
        base-ref: main
        head-ref: ${{ github.sha }}
