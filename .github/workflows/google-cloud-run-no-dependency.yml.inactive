# ===============================================================
# â˜ï¸  MCP Gateway â–¸ Build, Cache & Deploy to Google Cloud Run
# ===============================================================
# Maintainer: Mihai Criveti
# Status: Inactive
# This workflow:
#   - Restores / updates a local **BuildKit layer cache**  â„ï¸
#   - Builds the Docker image from **Containerfile.lite**  ğŸ—ï¸
#   - Pushes the image to **Google Artifact Registry**     ğŸ“¤
#   - Deploys to **Google Cloud Run** with autoscale=1     ğŸš€
#
# ---------------------------------------------------------------
# Prerequisites (one-time setup)
# ---------------------------------------------------------------
# 1. Create a Google Cloud project and enable billing
# 2. Enable required APIs:
#    gcloud services enable run.googleapis.com artifactregistry.googleapis.com
# 3. Create an Artifact Registry repository:
#    gcloud artifacts repositories create mcpgateway \
#      --repository-format=docker \
#      --location=us-central1 \
#      --description="MCP Gateway Docker images"
# 4. Create a service account with required permissions:
#      - Cloud Run Developer (only on mcpgateway service)
#      - Artifact Registry Writer (only on mcpgateway repository)
#    Example for restricted setup:
#      gcloud run services add-iam-policy-binding mcpgateway \
#        --region=us-central1 \
#        --member="serviceAccount:github-mcpgateway@PROJECT.iam.gserviceaccount.com" \
#        --role="roles/run.developer"
# 5. Create Cloud SQL (PostgreSQL) and Memorystore (Redis) instances
#    (see deployment documentation for commands)
#
# ---------------------------------------------------------------
# Required repository **secrets**
# ---------------------------------------------------------------
#  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#  â”‚ Secret name            â”‚ Description / Example value                                         â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ GCP_PROJECT_ID         â”‚ Your Google Cloud project identifier.                               â”‚
#  â”‚                        â”‚ While not a secret, it's sensitive and used as such for consistency.â”‚
#  â”‚                        â”‚ Example: "my-gcp-project-123456"                                    â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ GCP_SERVICE_KEY        â”‚ Service account JSON key for authentication to Google Cloud         â”‚
#  â”‚                        â”‚ Get from: IAM & Admin > Service Accounts > Keys > Add Key > JSON    â”‚
#  â”‚                        â”‚ Example: {"type": "service_account", "project_id": "my-project"...} â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ JWT_SECRET_KEY         â”‚ Random secret for signing JWT authentication tokens                 â”‚
#  â”‚                        â”‚ Generate with: openssl rand -base64 32                              â”‚
#  â”‚                        â”‚ Example: "xQ3Z5yDvEd2qP9kL7mN4wR8tU1aF6jH0bC3gI5sV"                 â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ BASIC_AUTH_PASSWORD    â”‚ Password for HTTP Basic Authentication (fallback auth method)       â”‚
#  â”‚                        â”‚ Example: "changeme-to-something-secure"                             â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ DATABASE_URL           â”‚ PostgreSQL connection string for Cloud SQL instance                 â”‚
#  â”‚                        â”‚ Format: postgresql://USER:PASS@IP:PORT/DATABASE                     â”‚
#  â”‚                        â”‚ Example: "postgresql://postgres:mypass@10.20.30.40:5432/mcpgw"      â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ REDIS_URL              â”‚ Redis connection string for Memorystore instance                    â”‚
#  â”‚                        â”‚ Format: redis://IP:PORT/DB_NUMBER                                   â”‚
#  â”‚                        â”‚ Example: "redis://10.20.30.50:6379/0"                               â”‚
#  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ---------------------------------------------------------------
# Required repository **variables**
# ---------------------------------------------------------------
#  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#  â”‚ Variable name              â”‚ Description / Example value                                     â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ GCP_REGION                 â”‚ Google Cloud region for deployment                              â”‚
#  â”‚                            â”‚ Example: "us-central1" (or us-east1, europe-west1, etc.)        â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ GAR_REPO_NAME              â”‚ Artifact Registry repository name (must exist)                  â”‚
#  â”‚                            â”‚ Example: "mcpgateway" or "docker-images"                        â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ IMAGE_NAME                 â”‚ Name for your Docker image                                      â”‚
#  â”‚                            â”‚ Example: "mcpgateway"                                           â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ CLOUD_RUN_SERVICE          â”‚ Name of the Cloud Run service                                   â”‚
#  â”‚                            â”‚ Example: "mcpgateway" or "mcp-gateway-prod"                     â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ CLOUD_RUN_PORT             â”‚ Port number the container listens on (numeric, no quotes)       â”‚
#  â”‚                            â”‚ Example: 4444                                                   â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ BASIC_AUTH_USER            â”‚ Username for HTTP Basic Authentication                          â”‚
#  â”‚                            â”‚ Example: "admin"                                                â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ CACHE_TYPE                 â”‚ Cache backend type for MCP Gateway                              â”‚
#  â”‚                            â”‚ Example: "redis" (or "memory" for development)                  â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ HOST                       â”‚ IP address to bind the service to (required for containers)     â”‚
#  â”‚                            â”‚ Must be: "0.0.0.0" (to listen on all interfaces)                â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ GUNICORN_WORKERS           â”‚ Number of Gunicorn worker processes (numeric, no quotes)        â”‚
#  â”‚                            â”‚ Example: 1 (keep low for cost efficiency)                       â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ CLOUD_RUN_CPU              â”‚ Number of vCPUs allocated (numeric, no quotes)                  â”‚
#  â”‚                            â”‚ Example: 1 (minimum is 0.08, maximum is 8)                      â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ CLOUD_RUN_MEMORY           â”‚ Memory allocation for the service                               â”‚
#  â”‚                            â”‚ Example: "512Mi" (minimum is 128Mi, maximum is 32Gi)            â”‚
#  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# Triggers:
#   - Every push to `main`
# ===============================================================

name: Deploy to Google Cloud Run

on:
  push:
    branches: ["main"]

permissions:
  contents: read

env:
  # â”€â”€â”€ project & registry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  GCP_REGION:          ${{ vars.GCP_REGION }}
  GAR_REPO_NAME:       ${{ vars.GAR_REPO_NAME }}
  IMAGE_NAME:          ${{ vars.IMAGE_NAME }}
  IMAGE_TAG:           ${{ github.sha }}
  CLOUD_RUN_SERVICE:   ${{ vars.CLOUD_RUN_SERVICE }}
  CLOUD_RUN_PORT:      ${{ vars.CLOUD_RUN_PORT }}

  # â”€â”€â”€ app configuration (non-secret) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  BASIC_AUTH_USER:     ${{ vars.BASIC_AUTH_USER }}
  CACHE_TYPE:          ${{ vars.CACHE_TYPE }}
  HOST:                ${{ vars.HOST }}
  GUNICORN_WORKERS:    ${{ vars.GUNICORN_WORKERS }}
  CLOUD_RUN_CPU:       ${{ vars.CLOUD_RUN_CPU }}
  CLOUD_RUN_MEMORY:    ${{ vars.CLOUD_RUN_MEMORY }}

  # â”€â”€â”€ secrets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  GCP_PROJECT_ID:      ${{ secrets.GCP_PROJECT_ID }}
  JWT_SECRET_KEY:      ${{ secrets.JWT_SECRET_KEY }}
  BASIC_AUTH_PASSWORD: ${{ secrets.BASIC_AUTH_PASSWORD }}
  DATABASE_URL:        ${{ secrets.DATABASE_URL }}
  REDIS_URL:           ${{ secrets.REDIS_URL }}

  # â”€â”€â”€ caching helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  CACHE_DIR:        /tmp/.buildx-cache

jobs:
  build-push-deploy:
    name: ğŸš€ Build, Cache, Push & Deploy
    runs-on: ubuntu-latest
    environment: google-cloud-run-production
    # Uses PostgreSQL database and Redis cache

    steps:
      # -----------------------------------------------------------
      # 0ï¸âƒ£  Checkout repository
      # -----------------------------------------------------------
      - name: â¬‡ï¸  Checkout source
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 1ï¸âƒ£  Authenticate to Google Cloud
      # -----------------------------------------------------------
      - name: ğŸ”  Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_KEY }}

      - name: ğŸ§°  Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      # -----------------------------------------------------------
      # 2ï¸âƒ£  Set up Docker Buildx + cache
      # -----------------------------------------------------------
      - name: ğŸ› ï¸  Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”„  Restore BuildKit cache
        uses: actions/cache@v4
        with:
          path: ${{ env.CACHE_DIR }}
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: ${{ runner.os }}-buildx-

      # -----------------------------------------------------------
      # 3ï¸âƒ£  Configure Docker to use gcloud auth
      # -----------------------------------------------------------
      - name: ğŸ”§  Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      # -----------------------------------------------------------
      # 4ï¸âƒ£  Build & tag image
      # -----------------------------------------------------------
      - name: ğŸ—ï¸  Build Docker image
        run: |
          docker buildx build \
            --file Containerfile.lite \
            --tag ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            --cache-from type=local,src=${{ env.CACHE_DIR }} \
            --cache-to   type=local,dest=${{ env.CACHE_DIR }},mode=max \
            --load \
            .

      # -----------------------------------------------------------
      # 5ï¸âƒ£  Push image to Artifact Registry
      # -----------------------------------------------------------
      - name: ğŸ“¤  Push image to GAR
        run: |
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      # -----------------------------------------------------------
      # 6ï¸âƒ£  Deploy to Cloud Run
      # -----------------------------------------------------------
      - name: ğŸš€  Deploy to Cloud Run
        run: |
          gcloud run deploy "$CLOUD_RUN_SERVICE" \
            --image "$GCP_REGION-docker.pkg.dev/$GCP_PROJECT_ID/$GAR_REPO_NAME/$IMAGE_NAME:$IMAGE_TAG" \
            --region "$GCP_REGION" \
            --platform managed \
            --allow-unauthenticated \
            --port "$CLOUD_RUN_PORT" \
            --cpu "$CLOUD_RUN_CPU" \
            --memory "$CLOUD_RUN_MEMORY" \
            --max-instances 1 \
            --set-env-vars "JWT_SECRET_KEY=$JWT_SECRET_KEY" \
            --set-env-vars "BASIC_AUTH_USER=$BASIC_AUTH_USER" \
            --set-env-vars "BASIC_AUTH_PASSWORD=$BASIC_AUTH_PASSWORD" \
            --set-env-vars "AUTH_REQUIRED=true" \
            --set-env-vars "DATABASE_URL=$DATABASE_URL" \
            --set-env-vars "REDIS_URL=$REDIS_URL" \
            --set-env-vars "CACHE_TYPE=$CACHE_TYPE" \
            --set-env-vars "HOST=$HOST" \
            --set-env-vars "GUNICORN_WORKERS=$GUNICORN_WORKERS"

      # -----------------------------------------------------------
      # 7ï¸âƒ£  Show deployment status
      # -----------------------------------------------------------
      - name: ğŸ“ˆ  Display deployment status
        run: |
          URL=$(gcloud run services describe "$CLOUD_RUN_SERVICE" --region "$GCP_REGION" --format "value(status.url)")
          echo "ğŸ‰ Service deployed to: $URL"
          echo "ğŸ“Š Service details:"
          gcloud run services describe "$CLOUD_RUN_SERVICE" --region "$GCP_REGION"
