# ===============================================================
# â˜ï¸  MCP Gateway â–¸ Build, Cache & Deploy to Google Cloud Run
# ===============================================================
#
# This workflow:
#   â€¢ Restores / updates a local **BuildKit layer cache**  â„ï¸
#   â€¢ Builds the Docker image from **Containerfile.lite**  ğŸ—ï¸
#   â€¢ Pushes the image to **Google Artifact Registry**     ğŸ“¤
#   â€¢ Deploys to **Google Cloud Run** with autoscale=1     ğŸš€
#
# ---------------------------------------------------------------
# Required repository **secrets**
# ---------------------------------------------------------------
#  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#  â”‚ Secret name            â”‚ Example value                  â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ GCP_SERVICE_KEY        â”‚ JSON string for gcloud auth    â”‚
#  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ---------------------------------------------------------------
# Required repository **variables**
# ---------------------------------------------------------------
#  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#  â”‚ Variable name              â”‚ Example value                â”‚
#  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#  â”‚ GCP_PROJECT_ID             â”‚ my-gcp-project               â”‚
#  â”‚ GCP_REGION                 â”‚ us-central1                  â”‚
#  â”‚ GAR_REPO_NAME              â”‚ mcpgateway                   â”‚
#  â”‚ IMAGE_NAME                 â”‚ mcpgateway                   â”‚
#  â”‚ CLOUD_RUN_SERVICE          â”‚ mcpgateway                   â”‚
#  â”‚ CLOUD_RUN_PORT             â”‚ "4444"                       â”‚
#  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# Triggers:
#   â€¢ Every push to `main`
# ===============================================================

name: Deploy to Google Cloud Run

on:
  push:
    branches: ["main"]

permissions:
  contents: read

env:
  GITHUB_SHA: ${{ github.sha }}
  CACHE_DIR: /tmp/.buildx-cache

  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION }}

  GAR_REPO_NAME: ${{ vars.GAR_REPO_NAME }}
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}
  IMAGE_TAG: ${{ github.sha }}

  CLOUD_RUN_SERVICE: ${{ vars.CLOUD_RUN_SERVICE }}
  CLOUD_RUN_PORT: ${{ vars.CLOUD_RUN_PORT }}

jobs:
  build-push-deploy:
    name: ğŸš€ Build, Cache, Push & Deploy
    runs-on: ubuntu-latest
    environment: production

    steps:
      # -----------------------------------------------------------
      # 0ï¸âƒ£  Checkout repository
      # -----------------------------------------------------------
      - name: â¬‡ï¸  Checkout source
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 1ï¸âƒ£  Authenticate to Google Cloud
      # -----------------------------------------------------------
      - name: ğŸ”  Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_KEY }}

      - name: ğŸ§°  Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          install_components: gcloud, docker
          export_default_credentials: true

      # -----------------------------------------------------------
      # 2ï¸âƒ£  Set up Docker Buildx + cache
      # -----------------------------------------------------------
      - name: ğŸ› ï¸  Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”„  Restore BuildKit cache
        uses: actions/cache@v4
        with:
          path: ${{ env.CACHE_DIR }}
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: ${{ runner.os }}-buildx-

      # -----------------------------------------------------------
      # 3ï¸âƒ£  Configure Docker to use gcloud auth
      # -----------------------------------------------------------
      - name: ğŸ”§  Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      # -----------------------------------------------------------
      # 4ï¸âƒ£  Build & tag image
      # -----------------------------------------------------------
      - name: ğŸ—ï¸  Build Docker image
        run: |
          docker buildx build \
            --file Containerfile.lite \
            --tag ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            --cache-from type=local,src=${{ env.CACHE_DIR }} \
            --cache-to   type=local,dest=${{ env.CACHE_DIR }},mode=max \
            --load \
            .

      # -----------------------------------------------------------
      # 5ï¸âƒ£  Push image to Artifact Registry
      # -----------------------------------------------------------
      - name: ğŸ“¤  Push image to GAR
        run: |
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.GAR_REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

      # -----------------------------------------------------------
      # 6ï¸âƒ£  Deploy to Cloud Run
      # -----------------------------------------------------------
      - name: ğŸš€  Deploy to Cloud Run
        run: |
          gcloud run deploy "$CLOUD_RUN_SERVICE" \
            --image $GCP_REGION-docker.pkg.dev/$GCP_PROJECT_ID/$GAR_REPO_NAME/$IMAGE_NAME:$IMAGE_TAG \
            --region "$GCP_REGION" \
            --platform managed \
            --allow-unauthenticated \
            --port "$CLOUD_RUN_PORT" \
            --cpu=2 \
            --memory=2Gi \
            --max-instances=1 \
            --set-env-vars=JWT_SECRET_KEY=your-secret,BASIC_AUTH_USER=admin,BASIC_AUTH_PASSWORD=changeme,AUTH_REQUIRED=true
