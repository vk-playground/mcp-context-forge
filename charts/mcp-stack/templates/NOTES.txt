{{- /*
   NOTES.txt for the "mcp-stack" Helm chart
   â€¢ Rendered after every install/upgrade.
   â€¢ Surfaces endpoints, credentials and helper commands so you can
     start interacting with the stack right away.
*/ -}}

{{- $ns := .Release.Namespace }}
{{- $fullName := include "mcp-stack.fullname" . }}

{{- /* -----------------------------------------------------------------
      Resource names (keep in sync with ./_helpers.tpl)
------------------------------------------------------------------*/ -}}
{{- $gatewaySvc  := printf "%s-mcpgateway"            $fullName }}
{{- $ftSvc       := printf "%s-mcp-fast-time-server"  $fullName }}
{{- $postgresSvc := printf "%s-postgres"              $fullName }}
{{- $redisSvc    := printf "%s-redis"                 $fullName }}
{{- $pgadminSvc  := printf "%s-pgadmin"               $fullName }}

{{- $gwSecret := printf "%s-gateway-secret" $fullName }}
{{- $pgSecret := include "mcp-stack.postgresSecretName" . }}

{{- /* -----------------------------------------------------------------
      Convenience shorthands
------------------------------------------------------------------*/ -}}
{{- $gwPort      := .Values.mcpContextForge.service.port | default 80 }}
{{- $pgPort      := .Values.postgres.service.port        | default 5432 }}
{{- $redisPort   := .Values.redis.service.port           | default 6379 }}
{{- $pgAdminPort := .Values.pgadmin.service.port         | default 80 }}

ğŸ‰  **{{ .Chart.Name }}** has been successfully deployed to namespace **{{ $ns }}**!

{{- /* â•â•â•â•â•â•â•â•â•â•â•â•  MCP Gateway  â•â•â•â•â•â•â•â•â•â•â•â• */}}
ğŸ”— **MCP Gateway**
{{- if .Values.mcpContextForge.ingress.enabled }}
  â€¢ Ingress URL  : https://{{ .Values.mcpContextForge.ingress.host }}{{ .Values.mcpContextForge.ingress.path | default "/" }}
{{- else }}
  â€¢ Service URL  : http://{{ $gatewaySvc }}.{{ $ns }}.svc.cluster.local:{{ $gwPort }}
{{- end }}
  â€¢ Basic-Auth :
      user      = {{ .Values.mcpContextForge.secret.BASIC_AUTH_USER }}
      password  = â¬‡ï¸
        `kubectl -n {{ $ns }} get secret {{ $gwSecret }} -o jsonpath="{.data.BASIC_AUTH_PASSWORD}" | base64 -d`
  â€¢ JWT signing key (JWT_SECRET_KEY) = â¬‡ï¸
        `kubectl -n {{ $ns }} get secret {{ $gwSecret }} -o jsonpath="{.data.JWT_SECRET_KEY}" | base64 -d`
  â€¢ Port-forward : `kubectl -n {{ $ns }} port-forward svc/{{ $gatewaySvc }} 4444:{{ $gwPort }}`

{{- /* â•â•â•â•â•â•â•â•â•â•â•â•  Fast-Time-Server  â•â•â•â•â•â•â•â•â•â•â•â• */}}
ğŸ”— **Fast-Time-Server (SSE)**
  â€¢ Cluster URL  : http://{{ $ftSvc }}.{{ $ns }}.svc.cluster.local
  â€¢ Via Gateway  : {{- if .Values.mcpContextForge.ingress.enabled }} https://{{ .Values.mcpContextForge.ingress.host }}/fast-time {{- else }} http://localhost:4444/fast-time {{- end }}

{{- /* â•â•â•â•â•â•â•â•â•â•â•â•  Datastores  â•â•â•â•â•â•â•â•â•â•â•â• */}}
ğŸ’¾ **Postgres**
  â€¢ Host / Port  : {{ $postgresSvc }}.{{ $ns }}.svc.cluster.local:{{ $pgPort }}
  â€¢ DB           : {{ .Values.postgres.credentials.database }}
  â€¢ User         : {{ .Values.postgres.credentials.user }}
  â€¢ Password     : `kubectl -n {{ $ns }} get secret {{ $pgSecret }} -o jsonpath="{.data.POSTGRES_PASSWORD}" | base64 -d`

ğŸ”‘ **Redis**
  â€¢ Host / Port  : {{ $redisSvc }}.{{ $ns }}.svc.cluster.local:{{ $redisPort }}

ğŸ“Š **PGAdmin**
  â€¢ URL          : http://{{ $pgadminSvc }}.{{ $ns }}.svc.cluster.local:{{ $pgAdminPort }}
  â€¢ Login        : {{ .Values.pgadmin.env.email }} / (same Postgres password)

{{- /* â•â•â•â•â•â•â•â•â•â•â•â•  Quick-start  â•â•â•â•â•â•â•â•â•â•â•â• */}}
ğŸš€ **Quick-start**

```bash
# 1) Forward the Gateway locally (skip if using ingress):
kubectl -n {{ $ns }} port-forward svc/{{ $gatewaySvc }} 4444:{{ $gwPort }} &

# 2) Obtain a JWT via Basic-Auth (requires 'jq'):
# TODO: this is not yet implemented use jwt tool locally instead
export GW_TOKEN=$(curl -s -u '{{ .Values.mcpContextForge.secret.BASIC_AUTH_USER }}:{{ .Values.mcpContextForge.secret.BASIC_AUTH_PASSWORD }}' \
  -X POST http://localhost:4444/auth/login | jq -r '.access_token')

# 3) Register the Fast-Time-Server with the Gateway:
curl -s -X POST \
     -H "Authorization: Bearer $GW_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"name":"local_time","url":"http://{{ $ftSvc }}.{{ $ns }}.svc.cluster.local/sse"}' \
     http://localhost:4444/gateways
```

ğŸ“š **Further reading**
â€¢ [https://ibm.github.io/mcp-context-forge/deployment/helm/](https://ibm.github.io/mcp-context-forge/deployment/helm/)
â€¢ [https://ibm.github.io/mcp-context-forge/testing/basic/](https://ibm.github.io/mcp-context-forge/testing/basic/)
